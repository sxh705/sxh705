<div id="sxh_app">
    <div class="all">
        <p>all {{view_timeAll}}</p>
        <p>now {{view_timeNow}}</p>
        <p>times {{freq}}</p>
        <p>
            <button  :class="bclass" @click="switxh">{{btn}}</button>
        </p>
        <p>
            <button @click="clean">清除</button>
        </p>
    </div>
</div>

<script>
    const timeOut = 30 * 1000;
    // 数据层
    let timeAll = 0 //总时间段 毫秒
    let timeStampNow = Date.now() //开始时间点
    let timerId = setTimeout(() => {
    }, 0) //更改颜色的timer
    let a = null;
    Vue.createApp({
        data: () => {
            return {
                //视图层
                freq: 0,
                state: 0,
                view_timeAll: 0, //视图总时间
                view_timeNow: 0, //视图当前时间
            }
        },
        computed: {
            bclass() {
                return `c_${a.state}`
            },
            btn() {
                return ['开始', '停止', '停止'][a.state]
            },
        },
        methods: {
            switxh() {
                if (a.state == 0) {
                    a.start();
                } else {
                    a.stop();
                }
            },
            start() {
                a.freq++;
                a.state = 1;
                timeStampNow = Date.now();
                clearTimeout(a.timerId);
                timerId = setTimeout(() => {
                    a.state = 2;
                }, timeOut);
            },
            stop() {
                a.state = 0;
                timeAll += Date.now() - timeStampNow;
                localStorage.setItem('timeAll', timeAll);
            },
            clean() {
                if (confirm("确认清除吗？")) {
                    a.stop();
                    timeAll = 0;
                }
            }
        },
        beforeCreate() {
            a = this;
            timeAll = parseFloat(localStorage.getItem('timeAll'));
        },
        mounted() {
            cov = (lefttime) => {
                //lefttime 距离结束时间的毫秒数
                let leftd = Math.floor(lefttime / (1000 * 60 * 60 * 24));
                let lefth = Math.floor(lefttime / (1000 * 60 * 60) % 24);
                let leftm = Math.floor(lefttime / (1000 * 60) % 60);
                let lefts = Math.floor(lefttime / 1000 % 60);
                return leftd + "d " + lefth + "h" + leftm + "m" + lefts + "s";
            }
            cov1 = (lefttime) => {
                let lefth = Math.floor(lefttime / (1000 * 60 * 60));
                let leftm = Math.floor(lefttime / (1000 * 60) % 60);
                let lefts = Math.floor(lefttime / 1000 % 60);
                let leftms = Math.floor(lefttime % 1000);
                return lefth + "h" + leftm + "m" + lefts + "s" + leftms + "ms";
            }
            f = () => {
                a.now = Date.now();
                let tNow, tAll;
                if (a.state == 0) {
                    tNow = 0;
                    tAll = timeAll;
                } else {
                    tNow = Date.now() - timeStampNow;
                    tAll = (timeAll + tNow);
                }
                // a.view_timeNow = (tNow / 1000).toFixed(1);
                // a.view_timeAll = (tAll / 1000).toFixed(1);
                a.view_timeAll = cov(tAll)
                a.view_timeNow = cov1(tNow)
            }
            f();
            setInterval(f, 100);
            // 不能用箭头函数，否则找不到this
            // 多层函数也会导致this进不去，提前设置一个a=this.
        },
        watch: {}
    }).mount('#sxh_app')
</script>

<style>
    .all {
        font-size: 20px;
        line-height: 200%;
        height: 800px
    }
    .c_0 {
        background-color: rgb(160, 255, 160);
        color: rgb(0, 0, 0);
    }
    .c_1 {
        background-color: rgb(255, 160, 160);
        color: rgb(0, 0, 0);
    }
    .c_2 {
        background-color: rgb(160, 160, 255);
        color: rgb(0, 0, 0);
    }
    button {
        font-size: 20px;
    }
</style>


